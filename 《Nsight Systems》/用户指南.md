## 为应用程序准备性能分析

Nsight Systems无需对应用程序进行任何更改即可启用分析；但是，通过进行一些简单的修改和添加，您可以极大地提高分析的有效性和所得数据的可用性。

### 聚焦分析

默认情况下，Nsight Systems 会在应用程序的整个运行过程中收集性能分析数据。但如下所述，您通常只希望对应用程序中包含部分或全部性能关键代码的区域进行性能分析。
将性能分析限制在性能关键区域可以减少您和工具都必须处理的数据量，并将注意力集中在那些通过优化能带来最大性能提升的代码上。

在几种常见情况下，将分析限制在应用程序的某个区域会很有帮助：

+ 该应用程序是一个测试工具，用于封装你的算法的全部或部分。这个测试工具可以**初始化数据**、**冷启动算法**，然后**检查结果的正确性**。使用测试工具是一种常见且高效的方法，能快速迭代和测试算法变更。在进行性能分析时，你会希望收集功能的性能分析数据，而不是测试工具的初始化和验证数据

+ 该应用程序分阶段运行，每个阶段会启用不同的算法集。当应用程序每个阶段的性能都可以独立于其他阶段进行优化时，你需要分别对每个阶段进行分析，以集中精力进行优化

+ 该应用程序包含的算法会进行大量迭代运算，但算法的性能在这些迭代过程中不会有显著变化。在这种情况下，你可以从一部分迭代中收集性能分析数据。

Nsight Systems支持两种代码注释方法来限制分析时长：

+ 为了将分析限制在CUDA应用程序的某个区域，CUDA提供了用于启动和停止数据收集的函数。```cudaProfilerStart()```用于启动分析，```cudaProfilerStop()```用于停止分析。要使用这些函数，必须包含```cuda_profiler_api.h```头文件。

+ 若要将分析限制在CPU活动的某个区域，您可以使用NVIDIA工具扩展API（NVTX）来设置分析范围。

### 标记和标注区域

若要了解应用程序的CPU线程在CUDA函数调用之外的行为，您可以使用NVIDIA工具扩展API（NVTX）。当您在应用程序中添加NVTX标记和范围后，时间线视图会显示您的CPU线程在这些区域内的执行时间。此外，时间线视图还会投射到GPU上，使您能够查看在该CPU范围内启动了哪些GPU活动。

为CPU和CUDA资源使用自定义名称也有助于更好地理解应用程序的行为，尤其是对于那些包含许多主机线程、设备、上下文或流的应用程序。你可以使用NVIDIA工具扩展API为CPU和GPU资源分配自定义名称。这些自定义名称随后会显示在时间线视图中。

## 从命令行界面进行分析

### 在目标设备上安装CLI

Nsight Systems 命令行界面提供了一个简单的接口，无需使用图形用户界面即可在目标设备上收集数据。收集到的数据随后可以复制到任何系统并在之后进行分析。

CLI 分布在标准 Nsight Systems 下载包的 Target 目录中。

如果您希望在非root权限下运行命令行界面（推荐模式），您需要将其安装在一个您拥有完全访问权限的目录中。

### 命令行选项

Nsight Systems 命令行可以有以下两种形式之一：

```bash
nsys [global_option]
```

或

```bash
nsys [command_switch][optional command_switch_options][application] [optional application_options]
```

所有命令行选项都区分大小写。对于命令开关选项，使用短选项时，参数应在开关后加空格；例如，```-s process-tree```。使用长选项时，开关后应跟一个等号，然后是参数；例如，```--sample=process-tree```。

对于此版本的Nsight Systems，如果您从命令行启动一个进程以开始分析，那么在收集完成时，启动的进程将会终止，包括设置了```--duration```的运行，除非用户指定```--kill none```选项（详情如下）。
例外情况是，如果用户使用NVTX、cudaProfilerStart/Stop或热键来控制时长，那么除非设置了--kill，否则应用程序将会继续运行。

Nsight Systems 命令行界面（CLI）通过会话支持并发分析。每个 Nsight Systems 会话由一系列 CLI 命令定义，这些命令用于定义一个或多个数据收集任务（例如，收集数据的时间和内容）。
会话以 start、launch 或 profile 命令开始。会话会在执行 shutdown 命令时、profile 命令终止时，或者（如果有要求）会话中启动的所有进程树退出时结束。多个会话可以在同一系统上并发运行。

#### CLI 全局选项

| 短 | 长 | 描述 |
|----|-----|-----|
| -h | --help | 提供有关可用命令开关及其选项信息的帮助消息 |
| -v | --version|  输出Nsight Systems CLI版本信息 |

### CLI 命令开关

Nsight Systems命令行界面可在两种模式下使用。您可以启动应用程序，并使用```nsys profile```命令指定的选项开始分析。或者，您可以使用交互式CLI命令控制应用程序的启动和数据收集。

| 命令 | 描述 |
|------|------|
| analyze | 对现有的Nsight Systems结果（无论是.nsys-rep格式还是SQLite格式）进行后处理，以生成专家系统报告 |
| export | 从现有的.nsys-rep文件生成导出文件 |
| launch | 在交互模式下，会在支持所请求选项的环境中启动应用程序。启动命令可以在开始命令之前或之后执行 |
| profile | 一个完整的分析描述，无需且不接受进一步输入。所使用的命令开关选项（见下表）决定了收集何时开始、何时停止、使用哪些收集器（例如，API跟踪、IP采样等）、监控哪些进程等 |
| recipe | 对一个或多个现有的Nsight Systems结果进行后处理，以生成统计信息并创建各种图表。详情请参见收集后分析指南 |
| sessions | 提供系统上所有正在运行的会话的信息 |
| shutdown | 将CLI进程与已启动的应用程序断开连接，并强制CLI进程退出。如果有收集操作处于挂起或活动状态，该操作将被取消 |
| start | 以交互模式启动一个收集。start命令可以在launch命令之前或之后执行 |
| stats | 对现有的Nsight Systems结果进行后处理（无论是.nsys-rep格式还是SQLite格式），以生成统计信息 |
| status | 报告基于CLI的收集状态或分析环境的适用性 |
| stop | 停止在交互模式下启动的收集。执行时，所有活动的收集都会停止，命令行界面进程终止，但应用程序继续运行 |

#### CLI Profile 命令开关选项

选择profile命令开关后，有以下选项可用。用法：

```bash
nsys [global-options] profile [options] [application] [application-arguments]
```

| 选项 | 可用参数（默认值加粗）| 开关说明 |
|------|---------------------|------------|
| --accelerator-trace | **none**, tegra-accelerators | 从硬件引擎单元收集其他加速器工作负载跟踪。仅在Nsight Systems嵌入式平台版中可用。此选项还将启用硬件加速器相关ftrace事件的收集。 |
| --after-collection-start |  |  |
| --after-report-ready | | 报告准备好后执行一条命令。该命令会在后续停止操作中重复使用，直到被重置或清除。传递不带值的选项可清除先前设置的命令。执行的进程会接收以下环境变量：NSYS_SESSION_NAME、NSYS_CALLBACK_NAME、NSYS_REPORT_PATH。|
| --auto-report-name | true，**false** | 使用所分析的图形应用程序的详细信息，从收集的数据中推导报告文件名。格式：[Process Name][GPU Name][Window Resolution][Graphics API] Timestamp .nsys-rep。如果为true，则自动生成报告文件名。 |
| --backtrace或-b | auto, fp, lbr, dwarf, none | 选择采样时要使用的回溯方法。选项lbr使用英特尔公司的LastBranch Record寄存器，仅在代号为Haswell及之后的英特尔CPU上可用。选项fp是帧指针，假设在编译期间启用了帧指针。选项dwarf使用DWARF的CFI（调用帧信息）。将值设置为none可以减少收集开销。默认情况下会选择CPU的最低开销选项。 |
| --capture-range或-c | **none**, cudaProfilerApi, hotkey, nvtx | 使用--capture-range时，只有调用适当的启动API或热键，性能分析才会开始。如果将--capture-range设置为none，启动/停止API调用和热键将被忽略。 |
| --capture-range-end | none, stop, **stop-shutdown**, repeat[:N], repeat-shutdown:N | 默认值为stop-shutdown。指定捕获范围结束时的预期行为。仅当与--capture-range选项一起使用时适用。如果为none，将忽略捕获范围的结束。如果为stop，收集将在捕获范围结束时停止。任何后续的捕获范围都将被忽略。目标应用程序将继续运行。如果为stop-shutdown，收集将在捕获范围结束时停止，并且会话将关闭。如果为repeat[:N]，收集将在捕获范围结束时停止，后续的捕获范围将触发更多收集。可选的:N指定要执行的最大捕获范围数量。一旦收集了N个捕获范围，任何后续的捕获范围都将被忽略。如果为repeat-shutdown:N，其行为与repeat:N相同，但在N个范围之后会话将关闭。对于stop-shutdown和repeat-shutdown:N，一如既往，使用--kill选项指定在关闭会话时是否应终止目标应用程序。 |
| --clock-frequency-changes | true, false true，false | 收集时钟频率变化。仅在Nsight Systems嵌入式平台版和Arm服务器（SBSA）平台中可用。 |
| --command-file | < filename >, none | 打开一个包含配置开关的文件并解析这些开关。请注意，命令行上的附加开关将覆盖文件中的开关。此标志可以多次指定。 |
| --cpu-cluster-events | 0x16, 0x17, …, none | 收集每个集群的Uncore PMU计数器。可以选择多个值，仅用逗号分隔（无空格）。使用--cpu-cluster-events=help开关查看完整的值列表。仅在Nsight Systems嵌入式平台版中可用。 |
| --cpu-core-events（Nsight Systems嵌入式平台版） | 0x11,0x13,…, none | 收集每个核心的PMU计数器。可以选择多个值，仅用逗号分隔（不含空格）。使用--cpu-core-events=help开关查看完整的值列表。 |




